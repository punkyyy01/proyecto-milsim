<!DOCTYPE html>
{% load static %}
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ORBAT - Task Force LATAM [SYSTEM V.FINAL]</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    
    {# Vercel Web Analytics #}
    <script defer src="/_vercel/insights/script.js"></script>

    <style>
        :root {
            /* --- COLORES TÁCTICOS VIBRANTES (JERARQUÍA) --- */
            --col-regiment: #ff3333;      /* ROJO - Nivel 1 */
            --col-company: #00a3ff;       /* AZUL - Nivel 2 */
            --col-platoon: #ffb400;       /* AMARILLO - Nivel 3 */
            --col-squad: #35d16b;         /* VERDE - Nivel 4 */
            --border-green: #00d689;      /* BORDE VERDE PARA TODO */
            --bg-dark: #0a0e11;
            --bg-card: #121820;
            --line-inactive: #2b5b45;
            --line-active: #67f0a3;
        }

        /* --- BASE --- */
        body {
            background-color: var(--bg-dark);
            color: #e8e8e8;
            font-family: 'Rajdhani', sans-serif;
            margin: 0; overflow: hidden; 
            width: 100vw; height: 100vh;
            cursor: grab; user-select: none;
        }
        body:active { cursor: grabbing; }

        /* Efecto CRT */
        body::before {
            content: " "; position: fixed;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            background-size: 100% 3px, 3px 100%;
            pointer-events: none; z-index: 1000;
        }

        /* Pantalla de Carga */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-family: 'Share Tech Mono', monospace; color: var(--col-squad);
            transition: opacity 0.5s ease;
        }
        .loader-bar { width: 300px; height: 4px; background: #333; margin-top: 10px; position: relative; overflow: hidden; }
        .loader-progress { width: 0%; height: 100%; background: var(--col-squad); animation: load 2.0s ease-out forwards; }
        @keyframes load { 0% { width: 0%; } 100% { width: 100%; } }

        /* Viewport */
        #viewport { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #canvas { transform-origin: center; transition: transform 0.1s ease-out; padding: 1000px; }
        .tf-header { 
            font-size: 48px; color: #ff7a1a; text-transform: uppercase; 
            letter-spacing: 4px; margin-bottom: 60px; text-align: center;
            font-weight: 700;
        }

        /* --- ARBOL Y CONECTORES (Layout Base) --- */
        .tree ul { padding-top: 20px; position: relative; display: flex; justify-content: center; border: none; border-radius: 0; padding: 15px; margin: 5px; }
        .tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 20px 5px 0 5px; transition: all 0.5s ease; }

        /* LÍNEAS BASE (GRISES) */
        /* Brazo Izquierdo (Before) y Derecho/Vertical (After) */
        .tree li::before, .tree li::after {
            content: ''; position: absolute; top: 0; 
            width: 50%; height: 20px;
            border-top: 2px solid var(--line-inactive); 
            transition: border-color 0.4s ease, opacity 0.4s ease;
        }
        .tree li::before { right: 50%; }
        .tree li::after { right: auto; left: 50%; border-left: 2px solid var(--line-inactive); }
        
        /* Limpieza de líneas base (First/Last child) */
        .tree li:only-child::after { border-top: none; }
        .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before { border: 0 none; }
        .tree li:last-child::after { border-top: none; }
        .tree li:last-child::before { border-radius: 0 5px 0 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        
        /* Línea vertical que baja del UL padre (Tallo Central) */
        .tree ul ul::before { 
            content: ''; position: absolute; top: 0; left: 50%; 
            border-left: 2px solid var(--line-inactive); 
            width: 0; height: 20px; transition: border-color 0.4s ease;
        }
        .tree > ul > li::before, .tree > ul > li::after { display: none !important; }
        .tree > ul > li { padding-top: 0 !important; }

        /* --- TARJETAS --- */
        .card {
            background: var(--bg-card); border: 2px solid var(--border-green); display: inline-block;
            border-radius: 3px; min-width: 160px; position: relative; z-index: 10;
            transition: all 0.3s ease; cursor: pointer;
        }
        .card:hover { border-color: #00ff99; box-shadow: 0 0 20px rgba(0, 214, 137, 0.4); transform: translateY(-2px); z-index: 11; }

        /* Niveles (Colores Jerárquicos) */
        .level-regiment { border: 1px solid #27323c; border-top: 4px solid var(--col-regiment); padding: 16px; min-width: 220px; }
        .level-regiment .unit-name { color: var(--col-regiment); }
        .level-regiment:hover .unit-name { text-shadow: 0 0 10px var(--col-regiment), 0 0 5px rgba(255, 51, 51, 0.5); }
        .level-company { border: 1px solid #27323c; border-top: 4px solid var(--col-company); padding: 14px; }
        .level-company .unit-name { color: var(--col-company); }
        .level-company:hover .unit-name { text-shadow: 0 0 10px var(--col-company), 0 0 5px rgba(0, 128, 255, 0.5); }
        .level-platoon { border: 1px solid #27323c; border-top: 4px solid var(--col-platoon); padding: 12px; }
        .level-platoon .unit-name { color: var(--col-platoon); }
        .level-platoon:hover .unit-name { text-shadow: 0 0 10px var(--col-platoon), 0 0 5px rgba(0, 214, 137, 0.5); }
        .unit-name { font-weight: bold; font-size: 1.6em; display: block; text-transform: uppercase; letter-spacing: 1px; }
        .commander-name { font-size: 1.05em; color: #ffffff; margin-top: 8px; display: block; font-weight: 500; }
        
        .level-squad { border: 1px solid #27323c; border-top: 4px solid var(--col-squad); background-color: var(--bg-card); padding: 0; min-width: 210px; box-shadow: 0 0 10px rgba(53, 209, 107, 0.15); }
        .squad-header { background-color: #0f1a28; color: var(--col-squad); padding: 12px; font-weight: bold; border-bottom: 2px solid var(--col-squad); font-size: 1.15em; letter-spacing: 0.5px; }
        .squad-header:hover { text-shadow: 0 0 8px var(--col-squad), 0 0 4px rgba(53, 209, 107, 0.5); }
        .roster-table { width: 100%; border-collapse: collapse; background-color: #121820; border: 1px solid #27323c; }
        .miembro-row { border-bottom: 1px solid #1f2a33; cursor: pointer; transition: 0.2s; }
        .miembro-row:hover { background-color: #1a3d52; box-shadow: inset 0 0 10px rgba(0, 214, 137, 0.15); }
        .roster-table td { padding: 10px 14px; color: #ffffff; text-align: left; font-size: 1.05em; border: 1px solid #1f2a33; }
        .rank-col { font-weight: bold; color: #ffffff; width: 50px; border-right: 1px solid #1f2a33; text-align: center; }
        .rank-col:hover { text-shadow: 0 0 8px var(--col-squad), 0 0 4px rgba(255, 170, 0, 0.5); }

        /* HQ Members Section */
        .hq-members { margin-top: 8px; width: 100%; }
        .hq-header { font-size: 0.75em; color: #888; text-transform: uppercase; letter-spacing: 1px; padding: 4px 8px; text-align: center; border-top: 1px solid #1f2a33; }
        .hq-roster { width: 100%; border-collapse: collapse; background-color: #121820; border: 1px solid #27323c; }
        .hq-roster td { padding: 8px 12px; color: #ffffff; text-align: left; font-size: 0.95em; border: 1px solid #1f2a33; }
        .level-regiment .hq-header { border-top-color: var(--col-regiment); color: var(--col-regiment); }
        .level-company .hq-header { border-top-color: var(--col-company); color: var(--col-company); }
        .level-platoon .hq-header { border-top-color: var(--col-platoon); color: var(--col-platoon); }

        /* Modal */
        .modal-militar { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); backdrop-filter: blur(8px); }
        .modal-content-militar { background-color: #121820; color: #ffffff; margin: 8% auto; padding: 50px; border: 2px solid var(--border-green); width: 520px; font-family: 'Courier New', monospace; box-shadow: 0 0 50px rgba(0, 214, 137, 0.25); position: relative; }
        .close-modal { position: absolute; top: 15px; right: 25px; font-size: 35px; cursor: pointer; color: #ff3333; }
        .close-modal:hover { text-shadow: 0 0 10px #ff3333, 0 0 5px rgba(255, 51, 51, 0.6); }
        .ficha-datos p { margin: 20px 0; font-size: 1.3em; border-left: 3px solid var(--border-green); padding-left: 28px; display: flex; align-items: baseline; }
        .ficha-datos strong { color: #ffffff; width: 190px; display: inline-block; }
        .watermark { position: absolute; bottom: 10px; right: 20px; font-size: 3em; opacity: 0.03; transform: rotate(-15deg); font-weight: bold; pointer-events: none; }
        
        #reset-view { position: fixed; bottom: 20px; right: 20px; z-index: 1500; font-size: 24px; color: var(--col-squad); background: rgba(0,0,0,0.5); border: 1px solid var(--col-squad); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        #reset-view:hover { background: var(--col-squad); color: #000; }

        /* --- LOGICA DE FOCO (CSS CORREGIDO) --- */
        
        /* 1. Estado "Filtering": Oscurecemos las TARJETAS, no los LIs */
        .tree.filtering .card {
            opacity: 1;
            filter: none;
            transform: scale(1);
        }

        /* 2. Tarjeta Activa: Se ilumina */
        .tree.filtering li.active-path > .card {
            opacity: 1;
            filter: none;
            transform: scale(1.05);
            z-index: 100;
            box-shadow: 0 0 30px rgba(255, 255, 255, 0.15);
            border-color: #eee;
        }

        /* 3. Líneas Verticales Activas */
        /* Línea que baja del UL padre hacia el grupo de hijos */
        .tree.filtering ul.active-path::before {
            border-left-color: var(--line-active) !important;
            filter: drop-shadow(0 0 4px var(--line-active));
            z-index: 50;
        }
        /* Línea vertical propia del LI (que baja hacia la tarjeta) */
        .tree.filtering li.active-vertical::after {
            border-left-color: var(--line-active) !important;
            filter: drop-shadow(0 0 2px var(--line-active));
            z-index: 51;
        }

        /* 4. Líneas Horizontales (Puentes Precisos) */
        /* Brazo izquierdo (Before) se ilumina */
        .tree.filtering li.connect-left::before {
            border-top-color: var(--line-active) !important;
            filter: drop-shadow(0 0 2px var(--line-active));
            z-index: 50;
        }
        /* Brazo derecho (After) se ilumina */
        .tree.filtering li.connect-right::after {
            border-top-color: var(--line-active) !important;
            filter: drop-shadow(0 0 2px var(--line-active));
            z-index: 50;
        }
        
    </style>
    <link rel="stylesheet" href="{% static 'orbat_style.css' %}">
    
    <!-- Vercel Web Analytics -->
    <script>
      window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
</head>
<body oncontextmenu="return false;"> 
    <!-- Botón para volver al admin -->
    <a href="/admin/" style="position:fixed;top:12px;left:12px;z-index:2000;background:rgba(0,0,0,0.6);color:#fff;padding:8px 12px;border:1px solid var(--col-squad);border-radius:4px;text-decoration:none;font-weight:600;">← Admin</a>

    <div id="boot-screen">
        <div class="boot-text">LOADING ORBAT SYSTEM...</div>
        <div class="loader-bar"><div class="loader-progress"></div></div>
    </div>

    <!-- Reseteo de vista eliminado (resaltado por click deshabilitado) -->

    <div id="viewport">
        <div id="canvas">
            <div class="tf-header">★ TASK FORCE LATAM (ORBAT) ★</div>
            
            <div class="tree">
                <ul>
                    {% for reg in regimientos %}
                    <li>
                        <div class="card level-regiment">
                            <span class="unit-name">{{ reg.nombre }}</span>
                            {% if reg.comandante %}<span class="commander-name">CO: {{ reg.comandante }}</span>{% endif %}
                            {% if reg.miembro_set.all %}
                            <div class="hq-members">
                                <div class="hq-header">HQ Staff</div>
                                <table class="hq-roster">
                                    {% for m in reg.miembro_set.all %}
                                    <tr class="miembro-row" onclick="mostrarFicha(this)"
                                        data-nombre="{{ m.nombre_milsim|escapejs }}"
                                        data-rango="{{ m.get_rango_display|escapejs }}"
                                        data-rol="{{ m.rol|default:'Fusilero'|escapejs }}"
                                        data-fecha="{{ m.fecha_ingreso|date:'d/m/Y'|escapejs }}">
                                        <td class="rank-col">{{ m.rango }}</td>
                                        <td>{{ m.nombre_milsim }}</td>
                                    </tr>
                                    {% endfor %}
                                </table>
                            </div>
                            {% endif %}
                        </div>
                        <ul>
                            {% for cia in reg.companias.all %}
                            <li>
                                <div class="card level-company">
                                    <span class="unit-name">{{ cia.nombre }}</span>
                                    {% if cia.miembro_set.all %}
                                    <div class="hq-members">
                                        <div class="hq-header">HQ Compañía</div>
                                        <table class="hq-roster">
                                            {% for m in cia.miembro_set.all %}
                                            <tr class="miembro-row" onclick="mostrarFicha(this)"
                                                data-nombre="{{ m.nombre_milsim|escapejs }}"
                                                data-rango="{{ m.get_rango_display|escapejs }}"
                                                data-rol="{{ m.rol|default:'Fusilero'|escapejs }}"
                                                data-fecha="{{ m.fecha_ingreso|date:'d/m/Y'|escapejs }}">
                                                <td class="rank-col">{{ m.rango }}</td>
                                                <td>{{ m.nombre_milsim }}</td>
                                            </tr>
                                            {% endfor %}
                                        </table>
                                    </div>
                                    {% endif %}
                                </div>
                                <ul>
                                    {% for plt in cia.pelotones.all %}
                                    <li>
                                        <div class="card level-platoon">
                                            <span class="unit-name">{{ plt.nombre }}</span>
                                            {% if plt.miembro_set.all %}
                                            <div class="hq-members">
                                                <div class="hq-header">HQ Pelotón</div>
                                                <table class="hq-roster">
                                                    {% for m in plt.miembro_set.all %}
                                                    <tr class="miembro-row" onclick="mostrarFicha(this)"
                                                        data-nombre="{{ m.nombre_milsim|escapejs }}"
                                                        data-rango="{{ m.get_rango_display|escapejs }}"
                                                        data-rol="{{ m.rol|default:'Fusilero'|escapejs }}"
                                                        data-fecha="{{ m.fecha_ingreso|date:'d/m/Y'|escapejs }}">
                                                        <td class="rank-col">{{ m.rango }}</td>
                                                        <td>{{ m.nombre_milsim }}</td>
                                                    </tr>
                                                    {% endfor %}
                                                </table>
                                            </div>
                                            {% endif %}
                                        </div>
                                        <ul>
                                            {% for sqd in plt.escuadras.all %}
                                            <li>
                                                <div class="card level-squad">
                                                    <div class="squad-header">{{ sqd.nombre }}</div>
                                                    <table class="roster-table">
                                                        {% for m in sqd.miembro_set.all %}
                                                        <tr class="miembro-row" onclick="mostrarFicha(this)" 
                                                            data-nombre="{{ m.nombre_milsim|escapejs }}" 
                                                            data-rango="{{ m.get_rango_display|escapejs }}" 
                                                            data-rol="{{ m.rol|default:'Fusilero'|escapejs }}" 
                                                            data-fecha="{{ m.fecha_ingreso|date:'d/m/Y'|escapejs }}">
                                                            <td class="rank-col">{{ m.rango }}</td>
                                                            <td>{{ m.nombre_milsim }}</td>
                                                        </tr>
                                                        {% empty %}
                                                        <tr><td colspan="2" style="text-align: center; color: #555; padding: 15px;">- SECTOR VACÍO -</td></tr>
                                                        {% endfor %}
                                                    </table>
                                                </div>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </li>
                            {% endfor %}
                        </ul>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div id="fichaModal" class="modal-militar">
        <div class="modal-content-militar">
            <span class="close-modal" onclick="cerrarFicha()">&times;</span>
            <h2 id="modalNombre">IDENTIFICANDO...</h2>
            <div class="ficha-datos">
                <p><strong>RANGO:</strong> <span id="modalRango"></span></p>
                <p><strong>ESPECIALIDAD:</strong> <span id="modalRol"></span></p>
                <p><strong>FECHA DE ALTA:</strong> <span id="modalFecha"></span></p>
                <p><strong>ESTADO:</strong> <span style="color: var(--col-squad);">OPERATIVO / ACTIVO</span></p>
            </div>
            <div class="watermark">CLASSIFIED</div>
        </div>
    </div>

    <script>
        // --- 1. BOOT SEQUENCE ---
        window.onload = function() {
            setTimeout(() => {
                document.getElementById('boot-screen').style.opacity = '0';
                setTimeout(() => { document.getElementById('boot-screen').style.display = 'none'; }, 500);
            }, 1500);
        };

        // --- 2. NAVEGACIÓN (Zoom y Pan) ---
        const canvas = document.getElementById('canvas');
        let scale = 0.8; let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;

        updateTransform();

        window.addEventListener('wheel', (e) => {
            if (e.target.closest('.modal-content-militar')) return; 
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.1 : 0.1;
            scale = Math.min(Math.max(0.2, scale + delta), 2.5);
            updateTransform();
        }, { passive: false });

        window.addEventListener('mousedown', (e) => {
            if (e.button === 2 || e.button === 0) { 
                if (e.button === 0 && e.target.closest('.card')) return; 
                isDragging = true;
                startX = e.clientX - translateX;
                startY = e.clientY - translateY;
                document.body.style.cursor = "grabbing";
            }
        });

        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            updateTransform();
        });

        window.addEventListener('mouseup', () => { isDragging = false; document.body.style.cursor = "grab"; });
        function updateTransform() { canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`; }
        
        // reset-view and focus/highlight functionality removed

        // --- 4. MODAL ---
        function mostrarFicha(elemento) {
            if (window.event) window.event.stopPropagation();
            document.getElementById('modalNombre').innerText = elemento.getAttribute('data-nombre');
            document.getElementById('modalRango').innerText = elemento.getAttribute('data-rango');
            document.getElementById('modalRol').innerText = elemento.getAttribute('data-rol');
            document.getElementById('modalFecha').innerText = elemento.getAttribute('data-fecha');
            document.getElementById('fichaModal').style.display = "block";
        }
        function cerrarFicha() { document.getElementById('fichaModal').style.display = "none"; }
        document.getElementById('fichaModal').onclick = function(event) { if (event.target === this) this.style.display = "none"; }
    </script>
</body>
</html>